name: CI

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  analyze:
    name: Analyze & Lint
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.9.2'
          channel: 'stable'
          cache: true

      - name: Flutter version
        run: flutter --version

      - name: Install dependencies
        run: flutter pub get

      - name: Check code formatting
        run: dart format --set-exit-if-changed .

      - name: Analyze code
        run: flutter analyze --fatal-infos

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: analyze
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.9.2'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Create mock Firebase config
        run: |
          mkdir -p android/app
          mkdir -p ios/Runner
          cp lib/firebase_options.dart.example lib/firebase_options.dart || echo "No example file found, tests should handle this"

      - name: Run unit tests
        run: flutter test --coverage --test-randomize-ordering-seed=random

      - name: Check test coverage
        run: |
          if [ -f coverage/lcov.info ]; then
            echo "✅ Coverage file generated"
            lcov --summary coverage/lcov.info || echo "lcov not available"
          else
            echo "⚠️ No coverage file generated"
          fi

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: success()
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false
          verbose: true
        continue-on-error: true

  build:
    name: Build App
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.9.2'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Create mock Firebase config
        run: |
          mkdir -p android/app
          mkdir -p ios/Runner
          cp lib/firebase_options.dart.example lib/firebase_options.dart || true
          
          cat > android/app/google-services.json << 'EOF'
          {
            "project_info": {
              "project_number": "123456789",
              "project_id": "padelhub-mock"
            },
            "client": [
              {
                "client_info": {
                  "mobilesdk_app_id": "1:123456789:android:abc123",
                  "android_client_info": {
                    "package_name": "com.example.padelhub"
                  }
                }
              }
            ]
          }
          EOF

      - name: Build Android APK
        run: flutter build apk --debug --no-shrink

      - name: Build Web
        run: flutter build web --release

      - name: Build complete
        run: echo "✅ All builds completed successfully"
